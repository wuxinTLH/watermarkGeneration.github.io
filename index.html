<!DOCTYPE html>
<!--
/**
* @name 水印生成器
* @version 0.0.0.1-alpha
* @author SakuraMikku
* @description 用于生成水印
* @createTime 2024-12-2
* @updateTime 2024-12-6
*
-->
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>水印生成器</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body,
    html {
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f0f0f0;
    }

    #default,
    #background {
      width: 99vw;
      height: 99.9vh;
      position: absolute;
      top: 0;
      left: 0;
    }

    #default {
      padding-top: 45px;
    }

    #background {
      /* background-color: green; */
      display: none;
      width: 99.9vw;
      /* 默认隐藏 */
    }

    #watermarkCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #controls {
      position: relative;
      background: rgba(255, 255, 255, 0.8);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 300px;
      width: 90%;
      margin: 0 auto;
      /* 使内容水平居中 */
    }

    #controls h1 {
      color: skyblue;
      font-size: 24px;
      margin-bottom: 20px;
    }

    #controls label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #333;
    }

    #controls input,
    #controls select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      appearance: none;
      /* 移除默认样式 */
      -webkit-appearance: none;
      /* Safari 和 Chrome */
      -moz-appearance: none;
      /* Firefox */
      background-size: 16px 16px;
    }

    #controls button {
      width: 100%;
      height: 48px;
      font-size: 24px;
      border: none;
      border-radius: 12px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #controls button:hover {
      background-color: #0056b3;
    }

    #controls div {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>

<body>
  <div id="default">
    <div id="controls">
      <h1>水印生成器</h1>

      <label for="watermarkStyle">水印类型(默认全屏水印)</label>
      <select name="" id="watermarkStyleSelect">
        <option value="1" selected>全屏水印 - 移动的文字</option>
        <option value="2">固定位置水印 - 固定位置的文字</option>
        <option value="3">环形水印 - 环绕中心的文字</option>
        <option value="4">其他 - 待定</option>
      </select>

      <label for="text">水印文字:</label>
      <input type="text" id="text" value="@copyright" />

      <label for="fontSize">字体大小 (px):</label>
      <input type="number" id="fontSize" value="40" min="10" max="100" class="always-visible" />

      <label for="charAlpha">水印字符透明度 (默认0.5):</label>
      <input type="number" id="charAlpha" value="0.5" min="0.1" max="1" step="0.1" class="always-visible" />

      <label for="speed" class="full-screen-only">水印移动速度 (默认1):</label>
      <input type="number" id="speed" value="1" min="0" max="10" class="full-screen-only" />

      <label for="angle" class="full-screen-only">水印角度 (默认45度,90度会卡死,负数不行):</label>
      <input type="number" id="angle" value="45" min="0" max="89" class="full-screen-only" />

      <label for="targetRows" class="full-screen-only">目标行数 (默认8):</label>
      <input type="number" id="targetRows" value="8" min="1" max="20" class="full-screen-only" />

      <label for="charSpacing" class="full-screen-only">水印字符间距 (默认240):</label>
      <input type="number" id="charSpacing" value="240" min="100" max="600" class="full-screen-only" />

      <label for="ramdomSpacing" class="full-screen-only">随机间距:</label>
      <select name="" id="ramdomSpacingSelect" class="full-screen-only">
        <option value="0" selected class="full-screen-only">否</option>
        <option value="1" class="full-screen-only">是</option>
      </select>

      <div class="fixed-watermark-params" style="display: none">
        <label for="fixedX">固定位置X坐标 (px):</label>
        <input type="number" id="fixedX" value="0" min="-1000" max="1000" />

        <label for="fixedY">固定位置Y坐标 (px):</label>
        <input type="number" id="fixedY" value="0" min="-1000" max="1000" />
      </div>

      <div class="circular-watermark-params" style="display: none">
        <label for="circleCenterX">圆心X坐标 (px):</label>
        <input type="number" id="circleCenterX" value="0" min="-1000" max="1000" />

        <label for="circleCenterY">圆心Y坐标 (px):</label>
        <input type="number" id="circleCenterY" value="0" min="-1000" max="1000" />

        <label for="radius">环形半径 (px):</label>
        <input type="number" id="radius" value="150" min="10" max="1000" />

        <label for="circularSpeed">水印移动速度 (默认1):</label>
        <input type="number" id="circularSpeed" value="1" min="0" max="10" />

        <label for="ringCount">环数 (默认1):</label>
        <input type="number" id="ringCount" value="1" min="1" max="10" />

        <label for="charSpacingCircular">文字间隔 (默认20°):</label>
        <input type="number" id="charSpacingCircular" value="20" min="1" max="360" />
      </div>



      <button id="confirm">确认并展示</button>
      <div>
        展示后按下S键开始录制,ESC键退出并保存录制(开始录制情况下)
      </div>
      <div>
        ~或`键退出录制不保存视频
      </div>
    </div>
  </div>
  <div id="background">
    <canvas id="watermarkCanvas"></canvas>
  </div>

  <script>
    // 获取DOM元素
    var canvas = document.getElementById("watermarkCanvas");
    var ctx = canvas.getContext("2d");

    //公共部分
    const textInput = document.getElementById("text");
    const charAlpha = document.getElementById("charAlpha");
    const fontSizeInput = document.getElementById("fontSize");

    //全屏水印
    const speedInput = document.getElementById("speed");
    const angleInput = document.getElementById("angle");
    const targetRowsInput = document.getElementById("targetRows");
    const charSpacingInput = document.getElementById("charSpacing");
    const confirmButton = document.getElementById("confirm");
    const defaultDiv = document.getElementById("default");
    const backgroundDiv = document.getElementById("background");
    const watermarkStyleSelect = document.getElementById("watermarkStyleSelect");
    const randomSpacingSelect = document.getElementById("ramdomSpacingSelect");

    //固定位置
    const fixedMarkPositionXInput = document.getElementById("fixedX");
    const fixedMarkPositionYInput = document.getElementById("fixedY");

    //环形水印
    const circleCenterXInput = document.getElementById("circleCenterX");
    const circleCenterYInput = document.getElementById("circleCenterY");
    const circleRadiusInput = document.getElementById("radius");
    const circularSpeedInput = document.getElementById("circularSpeed");
    const circleRingCountInput = document.getElementById("ringCount");
    const circleCharSpacingCircularInput = document.getElementById("charSpacingCircular");


    let isRecording = false;

    // 用于存储当前的动画帧请求ID
    let animationFrameId;

    // 用于存储媒体录制器和录制的数据块
    let mediaRecorder, recordedChunks = [];

    // 水印移动的偏移量
    let offset = 0;

    // 检查是否支持 MediaRecorder API
    function checkMediaRecorderSupport() {
      if (!('MediaRecorder' in window)) {
        alert("您的浏览器不支持录制功能，请手动录制视频。");
        // 可以在这里禁用相关的UI元素，防止用户尝试使用不可用的功能
        return false;
      }
      return true;
    }

    // 初始化画布
    function initCanvas() {
      // 重置 canvas 和 ctx
      const bg = document.querySelector("#background");
      if (bg.querySelector("#watermarkCanvas")) {
        bg.removeChild(bg.querySelector("#watermarkCanvas"));
      }
      const canv = document.createElement("canvas");
      canv.id = "watermarkCanvas";
      bg.appendChild(canv);
      canvas = document.querySelector("#watermarkCanvas");
      ctx = canvas.getContext("2d");

      // 重置偏移量
      offset = 0;

      // 调整 canvas 的大小
      resizeCanvas();

      // 填充整个 canvas 为绿色
      ctx.fillStyle = "green"; // 绿色
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // 监听watermarkStyleSelect的变化
    watermarkStyleSelect.addEventListener("change", function () {
      updateControls(this.value);
    });

    // 更新控件显示状态
    function updateControls(style) {
      const fullScreenOnlyElements = document.querySelectorAll(".full-screen-only");
      const fixedWatermarkParams = document.querySelector(".fixed-watermark-params");
      const circularWatermarkParams = document.querySelector(".circular-watermark-params");

      // 根据所选的水印类型显示/隐藏相应的元素
      if (style === "1") { // 全屏水印
        fullScreenOnlyElements.forEach((el) => (el.style.display = ""));
        fixedWatermarkParams.style.display = "none";
        circularWatermarkParams.style.display = "none";
      } else if (style === "2") { // 固定位置水印
        fullScreenOnlyElements.forEach((el) => (el.style.display = "none"));
        fixedWatermarkParams.style.display = "";
        circularWatermarkParams.style.display = "none";
      } else if (style === "3") { // 环形水印
        fullScreenOnlyElements.forEach((el) => (el.style.display = "none"));
        fixedWatermarkParams.style.display = "none";
        circularWatermarkParams.style.display = "";
      } else { // 其他类型的水印
        fullScreenOnlyElements.forEach((el) => (el.style.display = "none"));
        fixedWatermarkParams.style.display = "none";
        circularWatermarkParams.style.display = "none";
      }
    }

    // 默认情况下，如果不是全屏水印，则隐藏全屏水印特有的参数
    const fullScreenOnlyElements = document.querySelectorAll(".full-screen-only");
    fullScreenOnlyElements.forEach((el) => (el.style.display = "none"));

    // 默认情况下，隐藏固定位置水印和环形水印的参数
    const fixedWatermarkParams = document.querySelector(".fixed-watermark-params");
    const circularWatermarkParams = document.querySelector(".circular-watermark-params");
    fixedWatermarkParams.style.display = "none";
    circularWatermarkParams.style.display = "none";

    // 调整 canvas 的大小
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas(); // 初始设置

    // 绘制水印
    function drawWatermarks(param) {
      //text, fontSize, speed, angle, targetRows, charSpacing, alpha, watermarkStyle

      if (param.watermarkStyle === 1) {
        drawWatermarksTypeOne(param);
      } else if (param.watermarkStyle === 2) {
        drawWatermarksTypeTwo(param);
      } else if (param.watermarkStyle === 3) {
        drawWatermarksTypeThree(param);
      } else if (param.watermarkStyle === 4) {

      } else if (param.watermarkStyle === 5) {

      } else if (param.watermarkStyle === 6) {

      }
      // 请求下一帧
      animationFrameId = requestAnimationFrame(() => drawWatermarks(param));
    }

    //全屏水印
    function drawWatermarksTypeOne(param) {
      let text = param.text;
      let fontSize = param.fontSize;
      let speed = param.speed;
      let angle = param.angle;
      let targetRows = param.targetRows;
      let charSpacing = param.charSpacing;
      let alpha = param.alpha;
      let randomSpacing = param.randomSpacing || 0; // 默认值为0，表示不随机

      // 清除画布
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'green';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // 设置字体样式
      ctx.font = `${fontSize}px Arial`;
      ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";

      // 计算旋转中心点
      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate((angle * Math.PI) / 180); // 倾斜角度

      let textWidth = ctx.measureText(text).width;

      // 计算每行可以放置多少个文本实例
      const lineHeight = (canvas.height + fontSize) / targetRows; // 行间距

      for (let y = -canvas.height; y < canvas.height; y += lineHeight) {
        let x = (y - offset) * Math.tan((angle * Math.PI) / 180);

        // 确定起始x坐标，并在水平方向上重复绘制
        let startX = x - textWidth / 2;
        while (startX < canvas.width + textWidth) {
          // 继续绘制直到填满整个宽度
          ctx.fillText(text, startX, y);

          // 根据 randomSpacing 参数决定是否使用随机间距
          if (randomSpacing === 1) {
            // 生成一个基于 charSpacing 的随机间距
            let spacing = charSpacing + (Math.random() * 20 - 10); // 随机范围为 [-10, 10]
            startX += textWidth + spacing; // 增加随机字符间距
          } else {
            startX += textWidth + charSpacing; // 使用固定字符间距
          }
        }
      }
      ctx.restore();
      // 更新偏移量
      offset += speed;
    }


    //固定位置水印
    function drawWatermarksTypeTwo(param) {
      // 清除画布
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'green';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.font = `${param.fontSize}px Arial`;
      ctx.fillStyle = `rgba(255, 255, 255, ${param.alpha})`;
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";

      // 计算文本宽度
      let textWidth = ctx.measureText(param.text).width;

      // 在指定位置绘制水印
      ctx.fillText(
        param.text,
        param.fixedMarkPositionX - textWidth / 2, // 水平居中
        param.fixedMarkPositionY
      );

    }

    let lastTime = 0;
    // 绘制环形水印
    function drawWatermarksTypeThree(param) {
      // 清除画布
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'green';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      let fontSize = param.fontSize;
      let charSpacing = param.circleCharSpacing;
      const text = param.text;
      const centerX = param.circleCenterX;
      const centerY = param.circleCenterY;
      const radius = param.circleRadius;
      const ringCount = param.circleRingCount;
      const circularSpeed = param.circularSpeed;


      // 更新偏移量
      offset += circularSpeed;

      for (let ring = 0; ring < ringCount; ring++) {
        var currentRadius = radius + ring * (radius / ringCount); // 当前环的半径

        // 计算每个字符的宽度
        ctx.font = `${fontSize}px Arial`;
        var textWidth = ctx.measureText(text).width;
        var charsPerCircle = Math.floor((2 * Math.PI * currentRadius) / (textWidth + charSpacing));

        // 如果字符数量不足以形成完整的环，则减少字符间距或字体大小
        while (charsPerCircle < text.length) {
          if (charSpacing > 1) { // 尝试减小字符间距
            charSpacing -= 1;
          } else if (fontSize > 5) { // 如果字符间距已经很小，尝试减小字体大小
            fontSize -= 1;
            ctx.font = `${fontSize}px Arial`;
            textWidth = ctx.measureText(text).width;
          } else {
            break; // 字体大小和间距都已达到最小值，退出循环
          }
          var newCharsPerCircle = Math.floor((2 * Math.PI * currentRadius) / (textWidth + charSpacing));
          if (newCharsPerCircle >= text.length) break; // 如果现在可以放下所有字符，跳出循环
        }

        // 生成随机的起始角度偏移量
        var randomOffset = (Math.random() * 2 * Math.PI) - Math.PI; // 随机角度偏移量

        // 绘制每个字符
        for (let i = 0; i < text.length; i++) {
          var angle = (i / text.length) * 2 * Math.PI + randomOffset + (offset * Math.PI / 180); // 角度
          var x = centerX + currentRadius * Math.cos(angle);
          var y = centerY + currentRadius * Math.sin(angle);

          // 绘制单个字符
          ctx.fillText(text[i], x, y);
        }
      }
    }

    // 开始录制
    function startRecording() {
      const stream = canvas.captureStream();
      isRecording = true;
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream, {
        mimeType: "video/mp4",
      });
      mediaRecorder.ondataavailable = (event) => {
        if (event.data && event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };
      mediaRecorder.start();
    }

    // 停止录制并保存
    function stopRecordingAndSave() {
      isRecording = false;
      mediaRecorder.stop();
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/mp4" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = "水印.mp4";
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        }, 100);
      };
    }

    // 确认按钮点击事件处理程序
    confirmButton.onclick = function () {

      let param = {};
      param.text = textInput.value;
      param.fontSize = parseInt(fontSizeInput.value, 10);
      param.watermarkStyle = parseInt(watermarkStyleSelect.value);
      param.alpha = parseFloat(charAlpha.value);
      if (param.watermarkStyle === 1) {
        param.speed = parseFloat(speedInput.value);
        param.angle = parseFloat(angleInput.value);
        param.targetRows = parseInt(targetRowsInput.value, 10);
        param.charSpacing = parseInt(charSpacingInput.value, 10);
        param.randomSpacing = parseInt(randomSpacingSelect.value);
      } else if (param.watermarkStyle === 2) {
        param.fixedMarkPositionX = parseFloat(fixedMarkPositionXInput.value);
        param.fixedMarkPositionY = parseFloat(fixedMarkPositionYInput.value);
      } else if (param.watermarkStyle === 3) {
        param.circleCenterX = parseFloat(circleCenterXInput.value);
        param.circleCenterY = parseFloat(circleCenterYInput.value);
        param.circleRadius = parseFloat(circleRadiusInput.value);
        param.circularSpeed = parseFloat(circularSpeedInput.value);
        param.circleRingCount = parseFloat(circleRingCountInput.value);
        param.circleCharSpacing = parseFloat(circleCharSpacingCircularInput.value);

      } else if (param.watermarkStyle === 4) {

      }

      defaultDiv.style.display = "none";
      backgroundDiv.style.display = "block";

      // 开始绘制水印
      drawWatermarks(param);
    };

    // 键盘事件处理程序
    document.addEventListener("keydown", function (event) {
      if (event.key === "s" || event.key === "S") {
        startRecording(); // 开始录制

      } else if (
        (event.key === "Escape" || event.key === "~" || event.key === "`") &&
        backgroundDiv.style.display === "block"
      ) {
        backgroundDiv.style.display = "none";
        defaultDiv.style.display = "block";
        if (event.key === "Escape" && isRecording === true) {
          stopRecordingAndSave(); // 结束录制并保存视频
        } else if (event.key === "Escape" && isRecording === false) {
          stopRecordingWithoutSaving();
        } else if (event.key === "~" || event.key === "`") {
          stopRecordingWithoutSaving(); // 结束录制但不保存视频
        }

        // 取消之前的动画帧请求
        cancelAnimationFrame(animationFrameId);

        // 重置 canvas
        initCanvas();
      }
    });

    // 停止录制但不保存
    function stopRecordingWithoutSaving() {
      if (isRecording === true) {
        mediaRecorder.stop();
        mediaRecorder.onstop = () => {
          recordedChunks = []; // 清空录制数据
        };
      }

    }

    // 初始化控件显示状态
    function initControls() {
      // 默认选择全屏水印
      const defaultWatermarkStyle = '1';
      updateControls(defaultWatermarkStyle);
    }

    // 页面加载时执行的初始化函数
    function initialize() {
      // 检查是否支持 MediaRecorder API
      if (!checkMediaRecorderSupport()) {
        return; // 如果不支持，直接返回
      }

      // 初始化控件显示状态
      initControls();
    }

    // 执行初始化
    initialize();
  </script>
</body>

</html>